<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Directory index</title>
        <style>
            body {
                font-family: "Courier New", monospace;
                margin: 0;
                padding: 20px;
                background: #000;
                color: #e0e0e0;
            }
            body.dark {
                background: #050505;
                color: #f0f0f0;
            }
            #viewer-shell {
                max-width: 960px;
                margin: 0 auto;
            }
            #viewer-box {
                position: relative;
                border-radius: 14px;
                overflow: hidden;
                box-shadow:
                    0 18px 40px rgba(0, 0, 0, 0.7),
                    0 0 60px rgba(136, 136, 136, 0.45);
            }
            #noise-layer {
                position: absolute;
                inset: 0;
                z-index: 0;
            }
            #noise-layer svg {
                width: 100%;
                height: 100%;
                display: block;
            }
            #content-layer {
                position: relative;
                z-index: 1;
                padding: 18px 20px 16px 20px;
                background: linear-gradient(
                    145deg,
                    rgba(10, 10, 10, 0.96),
                    rgba(18, 18, 18, 0.98)
                );
                backdrop-filter: blur(10px);
            }
            #top-bar {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 10px;
            }
            #path-label {
                font-size: 12px;
                opacity: 0.7;
            }
            #darkToggle {
                padding: 4px 10px;
                border-radius: 999px;
                border: 1px solid rgba(136, 136, 136, 0.5);
                cursor: pointer;
                background: rgba(20, 20, 20, 0.9);
                color: #e0e0e0;
                font-size: 12px;
            }
            body.dark #darkToggle {
                background: #f0f0f0;
                color: #111;
                border-color: rgba(220, 220, 220, 0.9);
            }
            #breadcrumbs {
                font-size: 13px;
                margin-bottom: 10px;
            }
            #breadcrumbs .crumb {
                cursor: pointer;
                color: #9ed0ff;
            }
            #breadcrumbs .crumb:hover {
                color: #ffffff;
                text-shadow: 0 0 8px rgba(158, 208, 255, 0.6);
            }
            #listing {
                list-style: none;
                padding: 0;
                margin: 0;
                border-radius: 8px;
                background: rgba(5, 5, 5, 0.7);
                border: 1px solid rgba(90, 90, 90, 0.4);
            }
            #listing li {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 6px 10px;
                border-bottom: 1px solid rgba(70, 70, 70, 0.35);
                font-size: 13px;
            }
            #listing li:last-child {
                border-bottom: none;
            }
            #listing li img {
                width: 16px;
                height: 16px;
            }
            #listing li a {
                color: #e0e0e0;
                text-decoration: none;
            }
            #listing li a:hover {
                text-decoration: underline;
            }
            .meta {
                margin-left: auto;
                opacity: 0.7;
                font-size: 11px;
            }
            #status {
                margin-top: 10px;
                font-size: 11px;
                opacity: 0.7;
            }
            body.dark #listing {
                background: rgba(8, 8, 8, 0.9);
                border-color: rgba(130, 130, 130, 0.5);
            }
            body.dark #listing li {
                border-bottom-color: rgba(110, 110, 110, 0.5);
            }
            body.dark #viewer-box {
                box-shadow:
                    0 18px 40px rgba(0, 0, 0, 0.85),
                    0 0 70px rgba(180, 180, 180, 0.6);
            }
        </style>
    </head>
    <body>
        <div id="viewer-shell">
            <div id="viewer-box">
                <div id="noise-layer">
                    <svg
                        viewBox="0 0 200 200"
                        xmlns="http://www.w3.org/2000/svg"
                        preserveAspectRatio="none"
                    >
                        <filter id="noiseFilter">
                            <feTurbulence
                                type="fractalNoise"
                                baseFrequency="0.9"
                                numOctaves="4"
                                stitchTiles="stitch"
                            />
                        </filter>
                        <rect
                            width="100%"
                            height="100%"
                            filter="url(#noiseFilter)"
                            opacity="0.17"
                        />
                    </svg>
                </div>
                <div id="content-layer">
                    <div id="top-bar">
                        <div id="path-label"></div>
                        <button id="darkToggle">dark</button>
                    </div>
                    <div id="breadcrumbs"></div>
                    <ul id="listing"></ul>
                    <div id="status"></div>
                </div>
            </div>
        </div>
        <script>
            const ICONS = "../icons/";
            const repoOwner = "zynomon";
            const repoName = "error";
            const branch = "web-side";

            document.getElementById("darkToggle").onclick = function () {
                document.body.classList.toggle("dark");
            };

            let rawPath = window.location.pathname;
            rawPath = rawPath.replace(/^\/+/, "");
            rawPath = rawPath.replace(/^error\//, "");
            rawPath = rawPath.replace(/repo\.html$/, "");
            if (rawPath.endsWith("/")) rawPath = rawPath.slice(0, -1);
            const path = rawPath;

            document.getElementById("path-label").textContent =
                path === "" ? "/error" : "/error/" + path;

            function breadcrumbs(p) {
                const bc = document.getElementById("breadcrumbs");
                bc.innerHTML = "";
                const parts = p === "" ? ["root"] : p.split("/");
                let cur = "";
                parts.forEach(function (seg, i) {
                    if (seg !== "root") cur += (i ? "/" : "") + seg;
                    const span = document.createElement("span");
                    span.textContent = seg;
                    span.className = "crumb";
                    span.onclick = function () {
                        if (seg === "root") {
                            window.location.href = "/error/repo.html";
                        } else {
                            const upCount = parts.length - i - 1;
                            if (upCount <= 0) return;
                            const up = "../".repeat(upCount);
                            window.location.href = up + "repo.html";
                        }
                    };
                    bc.appendChild(span);
                    if (i < parts.length - 1)
                        bc.appendChild(document.createTextNode(" / "));
                });
            }

            function iconFor(name, type, p) {
                if (name === "..") return "dirback.png";
                if (type === "dir") return "dir.png";
                if (name.endsWith(".deb")) return "deb.png";
                if (name.indexOf("Packages") !== -1) return "pac.png";
                if (
                    [
                        "Release",
                        "InRelease",
                        "Release.gpg",
                        "error.gpg",
                    ].indexOf(name) !== -1
                )
                    return "key.png";
                if (
                    p.indexOf("/i18n/") !== -1 ||
                    name.indexOf("Translation") !== -1
                )
                    return "lang.png";
                return "other.png";
            }

            async function loadDir(p) {
                breadcrumbs(p);
                const ul = document.getElementById("listing");
                const status = document.getElementById("status");
                ul.innerHTML = "";
                status.textContent = "loading listingâ€¦";
                const api =
                    "https://api.github.com/repos/" +
                    repoOwner +
                    "/" +
                    repoName +
                    "/contents/" +
                    p +
                    "?ref=" +
                    branch;
                let data;
                try {
                    const res = await fetch(api);
                    data = await res.json();
                    if (!Array.isArray(data))
                        throw new Error("not a directory");
                } catch (e) {
                    ul.innerHTML = "";
                    const li = document.createElement("li");
                    li.textContent = "error loading directory";
                    ul.appendChild(li);
                    status.textContent = "";
                    return;
                }
                if (p !== "") {
                    const li = document.createElement("li");
                    const img = document.createElement("img");
                    img.src = ICONS + "dirback.png";
                    li.appendChild(img);
                    const a = document.createElement("a");
                    a.textContent = "..";
                    a.href = "../repo.html";
                    li.appendChild(a);
                    ul.appendChild(li);
                }
                data.sort(function (a, b) {
                    if (a.type === b.type) return a.name.localeCompare(b.name);
                    return a.type === "dir" ? -1 : 1;
                });
                for (const item of data) {
                    const li = document.createElement("li");
                    const img = document.createElement("img");
                    img.src = ICONS + iconFor(item.name, item.type, p);
                    li.appendChild(img);
                    const a = document.createElement("a");
                    a.textContent = item.name;
                    if (item.type === "dir") {
                        a.href = item.name + "/repo.html";
                    } else {
                        a.href = item.download_url;
                    }
                    li.appendChild(a);
                    ul.appendChild(li);
                }
                status.textContent = data.length + " item(s)";
            }

            loadDir(path);
        </script>
    </body>
</html>
