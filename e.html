<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Directory Index</title>

        <style>
            body {
                font-family: monospace;
                margin: 20px;
                background: #fafafa;
                color: #222;
            }
            body.dark {
                background: #111;
                color: #eee;
            }

            #darkToggle {
                padding: 6px 12px;
                border-radius: 4px;
                border: 1px solid #ccc;
                cursor: pointer;
                background: #f0f0f0;
                color: #222;
                margin-bottom: 12px;
            }
            body.dark #darkToggle {
                background: #222;
                color: #eee;
                border-color: #444;
            }

            #breadcrumbs {
                margin-bottom: 12px;
            }
            #breadcrumbs .crumb {
                cursor: pointer;
                color: #4da3ff;
            }

            #listing {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            #listing li {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 6px 10px;
                border-bottom: 1px solid rgba(128, 128, 128, 0.2);
            }
            #listing li img {
                width: 16px;
                height: 16px;
            }
            .meta {
                margin-left: auto;
                opacity: 0.7;
                font-size: 12px;
            }
        </style>
    </head>

    <body>
        <button id="darkToggle">dark</button>
        <div id="breadcrumbs"></div>
        <ul id="listing"></ul>

        <script>
            const ICONS = "../icons/";
            const repoOwner = "zynomon";
            const repoName = "error";
            const branch = "web-side";

            document.getElementById("darkToggle").onclick = () =>
                document.body.classList.toggle("dark");

            let path = window.location.pathname;

            path = path.replace(/^\/error\//, "");

            path = path.replace(/e\.html$/, "");

            if (path.endsWith("/")) path = path.slice(0, -1);

            function breadcrumbs(path) {
                const bc = document.getElementById("breadcrumbs");
                bc.innerHTML = "";

                const parts = path === "" ? ["root"] : path.split("/");
                let cur = "";

                parts.forEach((p, i) => {
                    if (p !== "root") cur += (i ? "/" : "") + p;

                    const span = document.createElement("span");
                    span.textContent = p;
                    span.className = "crumb";
                    span.onclick = () => {
                        window.location.href =
                            cur === ""
                                ? "./e.html"
                                : "../".repeat(parts.length - i - 1) + "e.html";
                    };

                    bc.appendChild(span);
                    if (i < parts.length - 1)
                        bc.appendChild(document.createTextNode(" / "));
                });
            }

            function iconFor(name, type, path) {
                if (name === "..") return "dirback.png";
                if (type === "dir") return "dir.png";
                if (name.endsWith(".deb")) return "deb.png";
                if (name.includes("Packages")) return "pac.png";
                if (
                    [
                        "Release",
                        "InRelease",
                        "Release.gpg",
                        "error.gpg",
                    ].includes(name)
                )
                    return "key.png";
                if (path.includes("/i18n/") || name.includes("Translation"))
                    return "lang.png";
                return "other.png";
            }

            async function loadDir(path) {
                breadcrumbs(path);

                const ul = document.getElementById("listing");
                ul.innerHTML = "";

                const api = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}?ref=${branch}`;

                let data;
                try {
                    const res = await fetch(api);
                    data = await res.json();
                    if (!Array.isArray(data)) throw 0;
                } catch {
                    ul.innerHTML = "<li>error loading directory</li>";
                    return;
                }

                if (path !== "") {
                    const li = document.createElement("li");

                    const img = document.createElement("img");
                    img.src = ICONS + "dirback.png";
                    li.appendChild(img);

                    const a = document.createElement("a");
                    a.textContent = "..";
                    a.href = "../e.html";
                    li.appendChild(a);

                    ul.appendChild(li);
                }

                data.sort((a, b) => {
                    if (a.type === b.type) return a.name.localeCompare(b.name);
                    return a.type === "dir" ? -1 : 1;
                });

                for (const item of data) {
                    const li = document.createElement("li");

                    const img = document.createElement("img");
                    img.src = ICONS + iconFor(item.name, item.type, path);
                    li.appendChild(img);

                    const a = document.createElement("a");
                    a.textContent = item.name;

                    if (item.type === "dir") {
                        a.href = item.name + "/e.html";
                    } else {
                        a.href = item.download_url;
                    }

                    li.appendChild(a);
                    ul.appendChild(li);
                }
            }

            loadDir(path);
        </script>
    </body>
</html>
